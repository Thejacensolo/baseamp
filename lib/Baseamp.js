// Generated by CoffeeScript 1.7.1
(function() {
  var Api, Baseamp, TodoLists, Util, async, debug, fs, packageJson, util, _;

  util = require("util");

  fs = require("fs");

  async = require("async");

  _ = require("underscore");

  debug = require("debug")("Baseamp:Baseamp");

  TodoLists = require("./TodoLists");

  Util = require("./Util");

  Api = require("./Api");

  packageJson = require("../package.json");

  Baseamp = (function() {
    function Baseamp(config) {
      this.api = new Api(config);
    }

    Baseamp.prototype.version = function(file, cb) {
      var stderr, stdout;
      stdout = "";
      stderr = "";
      stderr += "v" + packageJson.version;
      return cb(null, stdout, stderr);
    };

    Baseamp.prototype.help = function(file, cb) {
      var stderr, stdout;
      stdout = "";
      stderr = "";
      stderr += "" + packageJson.name + " v" + packageJson.version + "\n";
      stderr += " \n";
      stderr += " Usage:\n";
      stderr += " \n";
      stderr += "   " + packageJson.name + " action [args]\n";
      stderr += " \n";
      stderr += " Actions:\n";
      stderr += " \n";
      stderr += "       sync [file]  Syncs todos between Basecamp and markdown file\n";
      stderr += "   download [file]  Downloads latest todos from Basecamp, saved to file or STDOUT(-)\n";
      stderr += "     upload [file]  Uploads latest todos to Basecamp, sourcing from file\n";
      stderr += "    version         Reports version\n";
      stderr += "       help         This page\n";
      stderr += "\n";
      stderr += " More info: https://github.com/kvz/baseamp\n";
      return cb(null, stdout, stderr);
    };

    Baseamp.prototype.weekstarter = function(file, cb) {
      var buf, stderr, stdout, todo, todoLists, todos, _i, _len;
      stderr = "Read todo from " + file + "\n";
      stdout = "";
      buf = fs.readFileSync(file, "utf-8");
      todoLists = new TodoLists(buf);
      todos = todoLists.searchBetween("lwtw");
      for (_i = 0, _len = todos.length; _i < _len; _i++) {
        todo = todos[_i];
        stdout += todo.toMarkdown();
      }
      return cb(null, stdout, stderr);
    };

    Baseamp.prototype.upload = function(file, cb) {
      var buf, cbDone, changes, counter, stderr, stdout, todoLists;
      stderr = "Read todo from " + file + "\n";
      stdout = "";
      buf = fs.readFileSync(file, "utf-8");
      todoLists = new TodoLists(buf);
      counter = 0;
      changes = -1;
      cbDone = (function(_this) {
        return function(err, stats) {
          if (err) {
            return cb(err);
          }
          changes = stats.listsPushed + stats.todosPushed;
          counter += changes;
          debug("changes = " + changes);
          if (changes > 0) {
            return _this.api.uploadTodoLists(todoLists, cbDone);
          } else {
            stderr += "Uploaded " + counter + " changes. \n";
            return cb(err, stdout, stderr);
          }
        };
      })(this);
      return this.api.uploadTodoLists(todoLists, cbDone);
    };

    Baseamp.prototype.download = function(file, cb) {
      return this.api.downloadTodoLists(function(err, todoLists) {
        var buf, stderr, stdout;
        if (err) {
          return cb(err);
        }
        todoLists = new TodoLists(todoLists);
        buf = todoLists.toMarkdown();
        if (file === "-") {
          stderr = "";
          stdout = buf;
        } else {
          fs.writeFileSync(file, buf, "utf-8");
          stderr = "Written todo to " + file + "\n";
          stdout = "";
        }
        return cb(null, stdout, stderr);
      });
    };

    Baseamp.prototype.sync = function(file, cb) {
      return this.upload(file, (function(_this) {
        return function(err, stdoutUpload, stderrUpload) {
          if (err) {
            return cb(err);
          }
          return _this.download(file, function(err, stdoutDownload, stderrDownload) {
            if (err) {
              return cb(err);
            }
            return cb(null, "" + stdoutUpload + stdoutDownload, "" + stderrUpload + stderrDownload);
          });
        };
      })(this));
    };

    return Baseamp;

  })();

  module.exports = Baseamp;

}).call(this);

//# sourceMappingURL=Baseamp.map
